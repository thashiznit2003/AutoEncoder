services:
  autoencoder:
    image: linux-video-encoder:latest
    container_name: linux-video-encoder
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "5959:5959"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=America/Chicago
      # Enable NVIDIA GPU (requires NVIDIA Container Toolkit on the Docker host)
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      # Bind config and media paths (absolute for Portainer compatibility).
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/config.json:/linux-video-encoder/config.json
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/USB:/mnt/usb:rw,rslave
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/USBStaging:/mnt/usb_staging:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/DVD:/mnt/dvd:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/Bluray:/mnt/bluray:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/File:/mnt/input:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/Output:/mnt/output:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/Ripped:/mnt/ripped:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/SMBStaging:/mnt/smb_staging:rw
      - autoencoder_state:/var/lib/autoencoder/state:rw
    privileged: true
    devices:
      - /dev/sr0:/dev/sr0
      - /dev/sg0:/dev/sg0
      - /dev/sg1:/dev/sg1
      - /dev/bus/usb:/dev/bus/usb
      # - /dev/dri:/dev/dri

volumes:
  autoencoder_state:
