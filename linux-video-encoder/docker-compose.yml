services:
  autoencoder:
    image: linux-video-encoder:latest
    container_name: linux-video-encoder
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "5959:5959"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - TZ=America/Chicago
      # Enable NVIDIA GPU (requires NVIDIA Container Toolkit on the Docker host)
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      # Bind config and media paths (absolute for Portainer compatibility).
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/config.json:/linux-video-encoder/config.json
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/USB:/mnt/usb:rw,rslave
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/USBStaging:/mnt/usb_staging:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/DVD:/mnt/dvd:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/Bluray:/mnt/bluray:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/File:/mnt/input:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/Output:/mnt/output:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/Ripped:/mnt/ripped:rw
      - /linux-video-encoder/AutoEncoder/linux-video-encoder/SMBStaging:/mnt/smb_staging:rw
      # Optional development mounts (uncomment if you want live code/script edits).
      # - /linux-video-encoder/AutoEncoder/linux-video-encoder/src:/linux-video-encoder/src
      # - /linux-video-encoder/AutoEncoder/necessary-scripts:/linux-video-encoder/scripts
      - autoencoder_state:/var/lib/autoencoder/state:rw
    privileged: true
    devices:
      # Map your optical drive and (optionally) generic SCSI device into the container.
      - /dev/sr0:/dev/sr0
      - /dev/sg0:/dev/sg0
      - /dev/sg1:/dev/sg1
      # Pass USB bus for auto-mounting flash drives (requires host device access).
      - /dev/bus/usb:/dev/bus/usb
      # Uncomment if you want Intel QuickSync or another GPU exposed to ffmpeg/HandBrakeCLI.
      # - /dev/dri:/dev/dri
      # Map NVIDIA device nodes if you prefer explicit devices (NVIDIA Container Toolkit handles this automatically when installed).
      # - /dev/nvidia0:/dev/nvidia0
      # - /dev/nvidiactl:/dev/nvidiactl
      # - /dev/nvidia-uvm:/dev/nvidia-uvm
    # Uncomment if you need the container to mount/unmount devices itself (generally not needed if you bind mount).
    # privileged: true

volumes:
  autoencoder_state:
